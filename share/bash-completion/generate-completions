#!/usr/bin/env bash
#
#   generate-completions - install/update bash-completion scripts
#
#   This script generates certain completion files in the completions/
#   directory under it (normally ~/.local/share/bash-completion). Since
#   the regeneration can take several seconds, it normally checks the
#   files and regenerates them only if they are missing or more than
#   24 hours old.
#
#   Normally this would be run in .bashrc before sourcing all the files
#   in completions/.
#

set -o pipefail
basedir=$(cd "$(dirname "$0")" && pwd -P)

maxage=$((24*60*60))            # seconds
now=$(date +%s)

uptodate() {
    local file="$1"; shift
    [[ -a $file ]] || return 1      # Out of date if it doesn't exist.
    local lastmod=$(stat -c '%Y' $file)
    [[ $lastmod -ge $(($now - $maxage)) ]]
}

generate_pip() {
    echo '# Generated by ../generate-completions'
    if type pip3 >/dev/null 2>&1; then
        echo '# pip3 completion'
        #   Older versions of pip always set up completion for `pip`,
        #   even if run as `pip3`.
        pip3 2>/dev/null --disable-pip-version-check completion --bash \
                | sed -e 's/pip$/pip3/' \
                || { echo '# pip3 failed (no --disable-pip-version-check?)'
                     #   This is rare; probably an old system pip3 on
                     #   Ubuntu â‰¤ 14.04 or similar. Just ignore it; if we
                     #   care we should install our own personal pip.
                     return 0
                   }
        #   Set up completion for `pip` even if it's not available by default
        #   because it becomes available when a virtualenv is activated.
        pip3 --disable-pip-version-check completion --bash \
                | sed -e 's/pip3$/pip/'
    elif type pip >/dev/null 2>&1; then
        echo '# pip completion'
        pip  2>/dev/null --disable-pip-version-check completion --bash \
            || { echo '# pip failed (no --disable-pip-version-check?)'
                 return 0
               }
    else
        echo '# pip3/pip not available'
    fi
}

mkdir -p "$basedir/completions"
cd "$basedir/completions"

uptodate pip || generate_pip > pip
